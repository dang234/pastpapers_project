<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Upload Past Paper</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center px-4">

    <div class="w-full max-w-4xl bg-white p-8 rounded-xl shadow-md">
        <h2 class="text-2xl font-semibold text-center text-blue-700 mb-6">üì§ Upload Past Papers</h2>

        <!-- Upload Mode Toggle -->
        <div class="flex justify-center mb-6">
            <div class="bg-gray-200 p-1 rounded-lg">
                <button id="singleMode" class="px-4 py-2 rounded-md bg-blue-600 text-white transition-all">Single Upload</button>
                <button id="bulkMode" class="px-4 py-2 rounded-md text-gray-700 hover:bg-gray-300 transition-all">Bulk Upload</button>
            </div>
        </div>

        {% if success %}
            <div class="mb-4 bg-green-100 border border-green-300 text-green-700 px-4 py-2 rounded">
                ‚úÖ File(s) uploaded successfully!
            </div>
        {% endif %}

        <!-- Single Upload Form -->
        <div id="singleUploadForm">
            <form method="POST" enctype="multipart/form-data" class="space-y-5">
                {% csrf_token %}
                <input type="hidden" name="upload_type" value="single">

                <div>
                    <label for="title" class="block text-sm font-medium text-gray-700">Paper Title</label>
                    <input type="text" name="title" id="title" required
                        class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div>
                    <label for="course_code" class="block text-sm font-medium text-gray-700">Course Code</label>
                    <input type="text" name="course_code" id="course_code" required
                        class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div>
                    <label for="department" class="block text-sm font-medium text-gray-700">Department</label>
                    <input type="text" name="department" id="department" required
                        class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div>
                    <label for="year" class="block text-sm font-medium text-gray-700">Year</label>
                    <input type="number" name="year" id="year" required min="1900" max="2100"
                        class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div>
                    <label for="semester" class="block text-sm font-medium text-gray-700">Semester</label>
                    <input type="text" name="semester" id="semester" placeholder="e.g. Jan/May" required
                        class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div>
                    <label for="file" class="block text-sm font-medium text-gray-700">Upload File (PDF only)</label>
                    <input type="file" name="file" id="file" accept=".pdf" required
                        class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-md bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div>
                    <button type="submit"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition-all duration-200">
                        üìé Upload Paper
                    </button>
                </div>
            </form>
        </div>

        <!-- Bulk Upload Form -->
        <div id="bulkUploadForm" class="hidden">
            <form method="POST" enctype="multipart/form-data" class="space-y-5">
                {% csrf_token %}
                <input type="hidden" name="upload_type" value="bulk">

                <!-- Common fields for all files -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="bulk_department" class="block text-sm font-medium text-gray-700">Department (for all files)</label>
                        <input type="text" name="bulk_department" id="bulk_department" required
                            class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div>
                        <label for="bulk_year" class="block text-sm font-medium text-gray-700">Year (for all files)</label>
                        <input type="number" name="bulk_year" id="bulk_year" required min="1900" max="2100"
                            class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div>
                        <label for="bulk_semester" class="block text-sm font-medium text-gray-700">Semester (for all files)</label>
                        <input type="text" name="bulk_semester" id="bulk_semester" placeholder="e.g. Jan/May" required
                            class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>

                <!-- File upload area -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Upload Multiple Files (PDF only)</label>
                    
                    <!-- Drag and drop area -->
                    <div id="dropZone" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-400 transition-colors">
                        <div class="space-y-2">
                            <div class="text-4xl">üìÅ</div>
                            <div class="text-lg font-medium text-gray-700">Drag and drop files here</div>
                            <div class="text-sm text-gray-500">or</div>
                            <button type="button" id="selectFilesBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md transition-colors">
                                Select Files
                            </button>
                            <input type="file" id="bulkFiles" name="files" multiple accept=".pdf" class="hidden">
                        </div>
                    </div>
                </div>

                <!-- File list -->
                <div id="fileList" class="hidden">
                    <h3 class="text-lg font-medium text-gray-700 mb-3">Selected Files:</h3>
                    <div id="fileItems" class="space-y-2 max-h-60 overflow-y-auto"></div>
                </div>

                <!-- Naming convention help -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h4 class="font-medium text-blue-800 mb-2">üìù File Naming Convention</h4>
                    <p class="text-sm text-blue-700">
                        For best results, name your files like: <code class="bg-blue-100 px-1 rounded">COURSECODE_TITLE.pdf</code><br>
                        Example: <code class="bg-blue-100 px-1 rounded">CS101_Midterm_Exam.pdf</code>
                    </p>
                </div>

                <div>
                    <button type="submit" id="bulkSubmitBtn" disabled
                        class="w-full bg-gray-400 text-white font-medium py-2 px-4 rounded-md transition-all duration-200 disabled:cursor-not-allowed">
                        üìé Upload All Files
                    </button>
                </div>
            </form>
        </div>

        <!-- Progress indicator -->
        <div id="uploadProgress" class="hidden mt-4">
            <div class="bg-gray-200 rounded-full h-2">
                <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
            <p id="progressText" class="text-sm text-gray-600 mt-2">Uploading...</p>
        </div>
    </div>

    <script>
        const singleMode = document.getElementById('singleMode');
        const bulkMode = document.getElementById('bulkMode');
        const singleForm = document.getElementById('singleUploadForm');
        const bulkForm = document.getElementById('bulkUploadForm');
        const dropZone = document.getElementById('dropZone');
        const selectFilesBtn = document.getElementById('selectFilesBtn');
        const bulkFiles = document.getElementById('bulkFiles');
        const fileList = document.getElementById('fileList');
        const fileItems = document.getElementById('fileItems');
        const bulkSubmitBtn = document.getElementById('bulkSubmitBtn');

        let selectedFiles = [];

        // Mode switching
        singleMode.addEventListener('click', () => {
            singleMode.classList.add('bg-blue-600', 'text-white');
            singleMode.classList.remove('text-gray-700');
            bulkMode.classList.remove('bg-blue-600', 'text-white');
            bulkMode.classList.add('text-gray-700');
            singleForm.classList.remove('hidden');
            bulkForm.classList.add('hidden');
        });

        bulkMode.addEventListener('click', () => {
            bulkMode.classList.add('bg-blue-600', 'text-white');
            bulkMode.classList.remove('text-gray-700');
            singleMode.classList.remove('bg-blue-600', 'text-white');
            singleMode.classList.add('text-gray-700');
            singleForm.classList.add('hidden');
            bulkForm.classList.remove('hidden');
        });

        // File selection
        selectFilesBtn.addEventListener('click', () => {
            bulkFiles.click();
        });

        bulkFiles.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        // Drag and drop
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('border-blue-400', 'bg-blue-50');
        });

        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-blue-400', 'bg-blue-50');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-blue-400', 'bg-blue-50');
            handleFiles(e.dataTransfer.files);
        });

        function handleFiles(files) {
            selectedFiles = Array.from(files).filter(file => file.type === 'application/pdf');
            
            if (selectedFiles.length === 0) {
                alert('Please select PDF files only.');
                return;
            }

            displayFileList();
            bulkSubmitBtn.disabled = false;
            bulkSubmitBtn.classList.remove('bg-gray-400');
            bulkSubmitBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
        }

        function displayFileList() {
            fileItems.innerHTML = '';
            fileList.classList.remove('hidden');

            selectedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'flex items-center justify-between bg-gray-50 p-3 rounded';
                
                // Try to extract course code and title from filename
                const fileName = file.name.replace('.pdf', '');
                const parts = fileName.split('_');
                const courseCode = parts[0] || '';
                const title = parts.slice(1).join(' ') || fileName;

                fileItem.innerHTML = `
                    <div class="flex-1">
                        <div class="font-medium text-gray-800">${file.name}</div>
                        <div class="text-sm text-gray-500">Size: ${(file.size / 1024 / 1024).toFixed(2)} MB</div>
                        <div class="flex space-x-4 mt-2">
                            <input type="text" name="course_codes[]" placeholder="Course Code" value="${courseCode}" 
                                class="px-2 py-1 text-xs border rounded w-24" required>
                            <input type="text" name="titles[]" placeholder="Paper Title" value="${title}" 
                                class="px-2 py-1 text-xs border rounded flex-1" required>
                        </div>
                    </div>
                    <button type="button" onclick="removeFile(${index})" 
                        class="text-red-500 hover:text-red-700 ml-4">
                        ‚úï
                    </button>
                `;
                fileItems.appendChild(fileItem);
            });
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            
            // Update the file input
            const dt = new DataTransfer();
            selectedFiles.forEach(file => dt.items.add(file));
            bulkFiles.files = dt.files;
            
            if (selectedFiles.length === 0) {
                fileList.classList.add('hidden');
                bulkSubmitBtn.disabled = true;
                bulkSubmitBtn.classList.add('bg-gray-400');
                bulkSubmitBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            } else {
                displayFileList();
            }
        }
    </script>

</body>
</html>